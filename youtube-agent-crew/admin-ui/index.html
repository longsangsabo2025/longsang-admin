<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Äá»¨NG Dáº¬Y ÄI â€” Admin Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0a0f; --bg-card: #12121a; --bg-card-hover: #1a1a2e; --bg-input: #16161f;
      --border: #2a2a3a; --text: #e0e0e8; --text-dim: #8888a0; --text-bright: #ffffff;
      --accent: #ff6b35; --accent-glow: rgba(255,107,53,0.15); --accent2: #00d4aa; --accent3: #6366f1;
      --danger: #ef4444; --warning: #f59e0b; --success: #10b981; --radius: 12px; --shadow: 0 4px 24px rgba(0,0,0,0.4);
    }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.6; }
    a { color: var(--accent); text-decoration: none; } a:hover { text-decoration: underline; }
    .app { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 24px 0; position: fixed; top: 0; left: 0; bottom: 0; overflow-y: auto; z-index: 100; }
    .main { margin-left: 260px; flex: 1; padding: 32px; min-height: 100vh; }
    .sidebar-brand { padding: 0 24px 24px; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
    .sidebar-brand h1 { font-size: 18px; color: var(--accent); font-weight: 800; }
    .sidebar-brand p { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
    .nav-section { padding: 8px 16px; font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); margin-top: 12px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 24px; cursor: pointer; color: var(--text-dim); transition: all 0.2s; font-size: 14px; border-left: 3px solid transparent; }
    .nav-item:hover { background: var(--bg-card-hover); color: var(--text); }
    .nav-item.active { color: var(--accent); background: var(--accent-glow); border-left-color: var(--accent); font-weight: 600; }
    .nav-icon { font-size: 18px; width: 24px; text-align: center; }
    .nav-badge { margin-left: auto; background: var(--accent); color: #fff; font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; transition: all 0.2s; }
    .stat-card:hover { border-color: var(--accent); box-shadow: var(--shadow); }
    .stat-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .stat-value { font-size: 32px; font-weight: 800; color: var(--text-bright); line-height: 1; }
    .stat-sub { font-size: 12px; color: var(--text-dim); margin-top: 6px; }
    .stat-card.accent .stat-value { color: var(--accent); }
    .stat-card.green .stat-value { color: var(--accent2); }
    .stat-card.purple .stat-value { color: var(--accent3); }
    .page-header { margin-bottom: 24px; }
    .page-header h2 { font-size: 24px; font-weight: 700; color: var(--text-bright); }
    .page-header p { color: var(--text-dim); font-size: 14px; margin-top: 4px; }
    .table-wrap { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .table-toolbar { display: flex; align-items: center; gap: 12px; padding: 16px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .search-input { flex: 1; min-width: 200px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; color: var(--text); font-size: 14px; outline: none; }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--text-dim); }
    select.filter-select { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: var(--text); font-size: 13px; outline: none; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 12px 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); border-bottom: 1px solid var(--border); background: var(--bg); }
    tbody td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
    tbody tr { transition: background 0.15s; } tbody tr:hover { background: var(--bg-card-hover); }
    .video-title { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; color: var(--text-bright); }
    .video-title:hover { color: var(--accent); }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-cat { background: rgba(99,102,241,0.15); color: #818cf8; }
    .badge-source { background: rgba(0,212,170,0.12); color: var(--accent2); }
    .badge-success { background: rgba(16,185,129,0.15); color: var(--success); }
    .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
    .badge-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
    .badge-planned { background: rgba(99,102,241,0.15); color: #818cf8; }
    .badge-generating { background: rgba(245,158,11,0.15); color: var(--warning); animation: pulse 2s infinite; }
    .badge-generated { background: rgba(16,185,129,0.15); color: var(--success); }
    .badge-published { background: rgba(0,212,170,0.15); color: var(--accent2); }
    .badge-running { background: rgba(99,102,241,0.15); color: var(--accent3); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pagination { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-top: 1px solid var(--border); }
    .pagination-info { font-size: 13px; color: var(--text-dim); }
    .pagination-btns { display: flex; gap: 6px; }
    .page-btn { background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; padding: 6px 14px; color: var(--text); font-size: 13px; cursor: pointer; }
    .page-btn:hover { border-color: var(--accent); color: var(--accent); }
    .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .modal-overlay.active { opacity: 1; pointer-events: all; }
    .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 900px; max-height: 85vh; overflow-y: auto; box-shadow: 0 24px 80px rgba(0,0,0,0.6); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--border); }
    .modal-header h3 { font-size: 18px; color: var(--text-bright); font-weight: 700; }
    .modal-close { background: none; border: none; color: var(--text-dim); font-size: 24px; cursor: pointer; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 24px; }
    .transcript-content { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; font-size: 14px; line-height: 1.8; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }
    .transcript-meta { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
    .transcript-meta-item { font-size: 13px; color: var(--text-dim); }
    .transcript-meta-item strong { color: var(--text); }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
    .chart-card h4 { font-size: 14px; color: var(--text-bright); margin-bottom: 16px; font-weight: 700; }
    .bar-chart { display: flex; flex-direction: column; gap: 8px; }
    .bar-row { display: flex; align-items: center; gap: 10px; }
    .bar-label { width: 100px; font-size: 12px; color: var(--text-dim); text-align: right; flex-shrink: 0; }
    .bar-track { flex: 1; height: 22px; background: var(--bg); border-radius: 4px; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; display: flex; align-items: center; padding-left: 8px; font-size: 11px; font-weight: 700; color: #fff; min-width: 30px; }
    .content-viewer { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; font-size: 14px; line-height: 1.8; white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
    .tabs { display: flex; gap: 4px; margin-bottom: 16px; }
    .tab-btn { padding: 8px 20px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); color: var(--text-dim); cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #e55a2a; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
    .btn-sm { padding: 6px 14px; font-size: 12px; }
    .btn-danger { background: var(--danger); color: #fff; }
    .pipeline-form { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 24px; }
    .form-row { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 200px; }
    .form-group label { display: block; font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: var(--text); font-size: 14px; outline: none; font-family: inherit; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .run-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
    .run-info { flex: 1; }
    .run-id { font-size: 13px; color: var(--text-dim); font-family: monospace; }
    .run-name { font-size: 15px; color: var(--text-bright); font-weight: 600; }
    .run-meta { font-size: 12px; color: var(--text-dim); margin-top: 4px; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-dim); font-size: 14px; }
    .spinner { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px 20px; font-size: 14px; box-shadow: var(--shadow); animation: slideIn 0.3s ease; max-width: 400px; }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--danger); }
    .toast.info { border-left: 3px solid var(--accent3); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 24px; }
    .cal-header { font-size: 11px; text-transform: uppercase; color: var(--text-dim); text-align: center; padding: 8px 4px; letter-spacing: 1px; }
    .cal-day { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; min-height: 90px; padding: 8px; font-size: 12px; cursor: pointer; transition: all 0.15s; }
    .cal-day:hover { border-color: var(--accent); }
    .cal-day.today { border-color: var(--accent2); background: rgba(0,212,170,0.05); }
    .cal-day.has-content { border-color: var(--accent3); }
    .cal-day-num { font-weight: 700; color: var(--text-dim); margin-bottom: 4px; }
    .cal-day.today .cal-day-num { color: var(--accent2); }
    .cal-event { background: var(--accent-glow); border-left: 2px solid var(--accent); padding: 2px 6px; margin-top: 4px; border-radius: 4px; font-size: 10px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
    .cal-event:hover { background: rgba(255,107,53,0.3); }
    .cal-event.generated { border-left-color: var(--success); background: rgba(16,185,129,0.1); }
    .cal-event.published { border-left-color: var(--accent2); background: rgba(0,212,170,0.1); }
    .cal-day.other-month { opacity: 0.3; }
    .generating-overlay { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 40px; text-align: center; }
    .generating-overlay .spinner { display: inline-block; margin-bottom: 16px; width: 40px; height: 40px; border-width: 4px; }
    @media (max-width: 768px) { .sidebar { display: none; } .main { margin-left: 0; padding: 16px; } }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="app">
    <nav class="sidebar">
      <div class="sidebar-brand"><h1>ğŸ”¥ Äá»¨NG Dáº¬Y ÄI</h1><p>Video Factory Admin v2</p></div>
      <div class="nav-section">Dashboard</div>
      <div class="nav-item active" data-page="dashboard"><span class="nav-icon">ğŸ“Š</span><span>Tá»•ng quan</span></div>
      <div class="nav-section">Content</div>
      <div class="nav-item" data-page="generate"><span class="nav-icon">âœï¸</span><span>Táº¡o Script</span></div>
      <div class="nav-item" data-page="batch"><span class="nav-icon">ğŸš€</span><span>Batch Generate</span></div>
      <div class="nav-item" data-page="calendar"><span class="nav-icon">ğŸ“…</span><span>Content Calendar</span></div>
      <div class="nav-section">Knowledge Base</div>
      <div class="nav-item" data-page="videos"><span class="nav-icon">ğŸ¬</span><span>Video Transcripts</span><span class="nav-badge" id="nav-video-count">â€”</span></div>
      <div class="nav-item" data-page="brain"><span class="nav-icon">ğŸ§ </span><span>Brain & Voice</span></div>
      <div class="nav-item" data-page="search"><span class="nav-icon">ğŸ”</span><span>TÃ¬m kiáº¿m</span></div>
      <div class="nav-section">Production</div>
      <div class="nav-item" data-page="pipeline"><span class="nav-icon">âš¡</span><span>Pipeline</span></div>
      <div class="nav-item" data-page="outputs"><span class="nav-icon">ğŸ“¦</span><span>Videos Output</span></div>
    </nav>
    <main class="main"><div id="page-content"></div></main>
  </div>
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal"><div class="modal-header"><h3 id="modal-title">â€”</h3><button class="modal-close" onclick="closeModal()">&times;</button></div><div class="modal-body" id="modal-body"></div></div>
  </div>
  <div class="toast-container" id="toast-container"></div>

  <script>
    const API = '';
    let currentPage = 'dashboard';
    let statsCache = null;

    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.dataset.page;
        if (page === currentPage) return;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        currentPage = page;
        renderPage(page);
      });
    });

    async function renderPage(page) {
      const c = document.getElementById('page-content');
      c.innerHTML = '<div class="loading"><div class="spinner"></div>Äang táº£i...</div>';
      try {
        switch(page) {
          case 'dashboard': await renderDashboard(c); break;
          case 'generate': await renderGenerate(c); break;
          case 'batch': await renderBatch(c); break;
          case 'calendar': await renderCalendar(c); break;
          case 'videos': await renderVideos(c); break;
          case 'brain': await renderBrain(c); break;
          case 'search': await renderSearch(c); break;
          case 'pipeline': await renderPipeline(c); break;
          case 'outputs': await renderOutputs(c); break;
        }
      } catch(err) { c.innerHTML = `<div class="empty-state"><div class="icon">âš ï¸</div><p>${err.message}</p></div>`; }
    }

    async function api(path) { const r = await fetch(API + path); if (!r.ok) throw new Error(`API ${r.status}`); return r.json(); }
    async function apiPost(path, body) { const r = await fetch(API + path, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }); return r.json(); }
    async function apiPut(path, body) { const r = await fetch(API + path, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }); return r.json(); }
    async function apiDelete(path) { const r = await fetch(API + path, { method: 'DELETE' }); return r.json(); }
    function toast(msg, type='success') { const el = document.createElement('div'); el.className = `toast ${type}`; el.textContent = msg; document.getElementById('toast-container').appendChild(el); setTimeout(() => el.remove(), 5000); }
    function fmt(n) { if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return String(n||0); }
    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    const CAT = {'tam-ly':'ğŸ§  TÃ¢m lÃ½','tai-chinh':'ğŸ’° TÃ i chÃ­nh','phat-trien':'ğŸ“ˆ PhÃ¡t triá»ƒn','kinh-doanh':'ğŸ¢ Kinh doanh','dia-chinh-tri':'ğŸŒ Äá»‹a chÃ­nh trá»‹','xa-hoi':'ğŸ‘¥ XÃ£ há»™i','van-hoa':'ğŸ­ VÄƒn hÃ³a','suc-khoe':'ğŸ’ª Sá»©c khá»e','triet-hoc':'ğŸ“š Triáº¿t há»c'};
    const SRCC = {'hiddenself':'#6366f1','thuattaivan':'#f59e0b','hormozi':'#ef4444','akbimatluatngam':'#10b981'};

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderDashboard(c) {
      const s = await api('/api/admin/stats');
      statsCache = s;
      document.getElementById('nav-video-count').textContent = s.totalVideos;
      const cats = Object.entries(s.categories||{}).sort((a,b)=>b[1]-a[1]);
      const mx = cats[0]?.[1]||1;
      c.innerHTML = `
        <div class="page-header"><h2>ğŸ“Š Tá»•ng quan há»‡ thá»‘ng</h2><p>Äá»¨NG Dáº¬Y ÄI â€” Video Knowledge Factory</p></div>
        <div class="stats-grid">
          <div class="stat-card accent"><div class="stat-label">Video Transcripts</div><div class="stat-value">${s.totalVideos}</div><div class="stat-sub">${s.sources?.length||0} nguá»“n</div></div>
          <div class="stat-card green"><div class="stat-label">SÃ¡ch</div><div class="stat-value">${s.totalBooks}</div><div class="stat-sub">BRAIN: ${fmt(s.brainSize)} chars</div></div>
          <div class="stat-card purple"><div class="stat-label">Danh má»¥c</div><div class="stat-value">${cats.length}</div><div class="stat-sub">AI phÃ¢n loáº¡i</div></div>
          <div class="stat-card"><div class="stat-label">Videos Output</div><div class="stat-value">${s.videosGenerated}</div><div class="stat-sub">${s.pipeline?.activeRuns||0} Ä‘ang cháº¡y</div></div>
        </div>
        <div class="chart-grid">
          <div class="chart-card"><h4>ğŸ“¡ Nguá»“n dá»¯ liá»‡u</h4><div class="bar-chart">${(s.sources||[]).map(x=>`<div class="bar-row"><div class="bar-label">${x.label}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.round(x.totalVideos/s.totalVideos*100)}%;background:${SRCC[x.id]||'#6366f1'}">${x.totalVideos}</div></div></div>`).join('')}</div></div>
          <div class="chart-card"><h4>ğŸ“‚ Danh má»¥c</h4><div class="bar-chart">${cats.slice(0,8).map(([k,v])=>`<div class="bar-row"><div class="bar-label">${CAT[k]||k}</div><div class="bar-track"><div class="bar-fill" style="width:${Math.round(v/mx*100)}%;background:var(--accent3)">${v}</div></div></div>`).join('')}</div></div>
        </div>
        <div class="chart-card"><h4>âš™ï¸ Tráº¡ng thÃ¡i</h4><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-top:12px">
          <div><span style="color:var(--text-dim)">Uptime:</span> <strong>${Math.floor(s.uptime/3600)}h ${Math.floor(s.uptime%3600/60)}m</strong></div>
          <div><span style="color:var(--text-dim)">Version:</span> <strong>${s.version}</strong></div>
          <div><span style="color:var(--text-dim)">Brain:</span> <strong>${s.brainExists?'âœ…':'âŒ'}</strong></div>
          <div><span style="color:var(--text-dim)">Active:</span> <strong>${s.pipeline?.activeRuns||0}</strong></div>
        </div></div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• GENERATE SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderGenerate(c) {
      c.innerHTML = `
        <div class="page-header"><h2>âœï¸ Táº¡o Script</h2><p>AI viáº¿t script dá»±a trÃªn 815 videos + 28 sÃ¡ch</p></div>
        <div class="pipeline-form">
          <div class="form-row">
            <div class="form-group" style="flex:3"><label>Chá»§ Ä‘á»</label><input type="text" id="gen-topic" placeholder="VD: Táº¡i sao ngÆ°á»i giá»i nháº¥t láº¡i thÆ°á»ng thua cuá»™c?"></div>
            <button class="btn btn-primary" id="gen-btn" onclick="doGenerate()">âœï¸ Táº¡o Script</button>
          </div>
        </div>
        <div id="gen-result"></div>`;
    }

    async function doGenerate() {
      const topic = document.getElementById('gen-topic').value.trim();
      if (!topic) return toast('Nháº­p chá»§ Ä‘á»','error');
      const btn = document.getElementById('gen-btn');
      btn.disabled = true; btn.textContent = 'â³ Äang táº¡o...';
      const rd = document.getElementById('gen-result');
      rd.innerHTML = `<div class="generating-overlay"><div class="spinner"></div><p style="color:var(--text-bright);font-size:16px;font-weight:600">Äang táº¡o script...</p><p style="color:var(--text-dim);margin-top:8px">"${esc(topic)}"</p><p style="color:var(--text-dim);font-size:12px;margin-top:16px">Dá»± kiáº¿n: 15-25 giÃ¢y</p></div>`;
      try {
        const d = await apiPost('/api/admin/generate-script', { topic });
        if (d.error) throw new Error(d.error);
        rd.innerHTML = `<div class="pipeline-form" style="border-color:var(--success)">
          <h4 style="color:var(--success);margin-bottom:12px">âœ… Script táº¡o thÃ nh cÃ´ng!</h4>
          <div style="display:flex;gap:24px;font-size:13px;color:var(--text-dim);margin-bottom:16px"><span>ğŸ“ ${d.wordCount} tá»«</span><span>â±ï¸ â‰ˆ${(d.wordCount/150).toFixed(0)} phÃºt</span><span>ğŸ’° $${d.cost?.toFixed(4)||'0'}</span><span>ğŸ¤– ${d.model}</span></div>
          <div class="content-viewer" style="max-height:500px">${esc(d.script)}</div>
          <div style="margin-top:16px;display:flex;gap:8px">
            <button class="btn btn-outline btn-sm" onclick="navigator.clipboard.writeText(window._ls);toast('Copied!','info')">ğŸ“‹ Copy</button>
            <button class="btn btn-outline btn-sm" onclick="goCalendar('${esc(topic).replace(/'/g,"\\'")}')">ğŸ“… ThÃªm lá»‹ch</button>
          </div></div>`;
        window._ls = d.script;
        toast(`Script: ${d.wordCount} tá»«`,'success');
      } catch(err) { rd.innerHTML = `<div class="pipeline-form" style="border-color:var(--danger)"><p style="color:var(--danger)">âŒ ${err.message}</p></div>`; toast(err.message,'error'); }
      finally { btn.disabled = false; btn.textContent = 'âœï¸ Táº¡o Script'; }
    }

    function goCalendar(topic) {
      document.querySelector('[data-page="calendar"]').click();
      setTimeout(() => { showAddCal(); setTimeout(() => { const e = document.getElementById('cal-title'); if(e) e.value = topic; }, 100); }, 300);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• BATCH GENERATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderBatch(c) {
      c.innerHTML = `
        <div class="page-header"><h2>ğŸš€ Batch Generate</h2><p>Táº¡o nhiá»u scripts cÃ¹ng lÃºc</p></div>
        <div class="pipeline-form">
          <div class="tabs" style="margin-bottom:16px">
            <button class="tab-btn active" onclick="switchBM('manual',this)">ğŸ“ Nháº­p topics</button>
            <button class="tab-btn" onclick="switchBM('auto',this)">ğŸ¤– AI Auto</button>
          </div>
          <div id="bm-manual"><div class="form-group"><label>Danh sÃ¡ch chá»§ Ä‘á» (má»—i dÃ²ng 1 topic)</label><textarea id="batch-topics" rows="6" placeholder="Táº¡i sao ngÆ°á»i giá»i láº¡i nghÃ¨o?&#10;BÃ­ máº­t Ä‘áº±ng sau sá»± im láº·ng&#10;Luáº­t chÆ¡i mÃ  trÆ°á»ng há»c khÃ´ng dáº¡y"></textarea></div></div>
          <div id="bm-auto" style="display:none">
            <div class="form-row"><div class="form-group"><label>Sá»‘ topics</label><input type="number" id="batch-n" value="5" min="1" max="20"></div><button class="btn btn-outline" onclick="autoSug()">ğŸ¤– AI Suggest</button></div>
            <div id="bm-auto-r" style="margin-top:16px"></div>
          </div>
          <div style="margin-top:16px"><button class="btn btn-primary" id="batch-btn" onclick="doBatch()">ğŸš€ Báº¯t Ä‘áº§u Batch</button></div>
        </div>
        <div id="batch-progress"></div>
        <h4 style="margin:24px 0 12px;color:var(--text-bright)">ğŸ“ Batch History</h4>
        <div id="batch-list"><div class="loading"><div class="spinner"></div>Äang táº£i...</div></div>`;
      loadBatches();
    }

    function switchBM(mode, btn) {
      document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active');
      document.getElementById('bm-manual').style.display = mode==='manual'?'':'none';
      document.getElementById('bm-auto').style.display = mode==='auto'?'':'none';
    }

    async function autoSug() {
      const n = parseInt(document.getElementById('batch-n').value);
      const r = document.getElementById('bm-auto-r');
      r.innerHTML = '<div class="loading"><div class="spinner"></div>AI Ä‘ang nghÄ©...</div>';
      try {
        const d = await apiPost('/api/admin/batch-generate', { auto: n });
        if (d.topics?.length) {
          document.getElementById('batch-topics').value = d.topics.join('\n');
          document.getElementById('bm-manual').style.display = '';
          r.innerHTML = `<p style="color:var(--success)">âœ… ${d.topics.length} topics Ä‘Ã£ suggest â†’ chá»‰nh sá»­a á»Ÿ tab "Nháº­p topics"</p>`;
          toast(`AI suggest ${d.topics.length} topics`,'success');
        }
      } catch(e) { r.innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
    }

    async function doBatch() {
      const ta = document.getElementById('batch-topics');
      if (!ta) return toast('ChÆ°a nháº­p topics','error');
      const topics = ta.value.split('\n').map(t=>t.trim()).filter(Boolean);
      if (!topics.length) return toast('ChÆ°a nháº­p topics','error');
      const btn = document.getElementById('batch-btn');
      btn.disabled = true; btn.textContent = 'â³ Äang xá»­ lÃ½...';
      const pd = document.getElementById('batch-progress');
      pd.innerHTML = `<div class="generating-overlay"><div class="spinner"></div><p style="color:var(--text-bright);font-size:16px">Äang táº¡o ${topics.length} scripts...</p><p style="color:var(--text-dim);margin-top:8px">Dá»± kiáº¿n: ~${topics.length*20}s</p></div>`;
      try {
        const d = await apiPost('/api/admin/batch-generate', { topics });
        if (d.error) throw new Error(d.error);
        pd.innerHTML = `<div class="pipeline-form" style="border-color:var(--success)"><h4 style="color:var(--success)">âœ… Batch started: ${d.total} scripts</h4><p style="color:var(--text-dim);margin-top:8px">Batch ID: ${d.batchId} â€” Ä‘ang cháº¡y background</p></div>`;
        toast(`Batch: ${d.total} scripts started`,'success');
        setTimeout(loadBatches, 5000);
      } catch(e) { pd.innerHTML = `<div class="pipeline-form" style="border-color:var(--danger)"><p style="color:var(--danger)">âŒ ${e.message}</p></div>`; }
      finally { btn.disabled = false; btn.textContent = 'ğŸš€ Báº¯t Ä‘áº§u Batch'; }
    }

    async function loadBatches() {
      try {
        const d = await api('/api/admin/batches');
        const el = document.getElementById('batch-list');
        if (!d.batches?.length) { el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“</div><p>ChÆ°a cÃ³ batch</p></div>'; return; }
        el.innerHTML = d.batches.map(b => {
          const r = b.report;
          const ok = r?.success ?? r?.stats?.success ?? 0;
          const total = r?.total ?? r?.stats?.total ?? b.scripts;
          return `<div class="run-card"><div class="run-info"><div class="run-name">${b.id}</div><div class="run-meta">${ok}/${total} thÃ nh cÃ´ng Â· ${new Date(b.createdAt).toLocaleDateString('vi-VN')}</div></div><span class="badge ${r?.completedAt?'badge-success':'badge-warning'}">${r?.completedAt?'Xong':'Äang cháº¡y'}</span></div>`;
        }).join('');
      } catch(e) { document.getElementById('batch-list').innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTENT CALENDAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let calM = new Date().getMonth(), calY = new Date().getFullYear(), calData = null;

    async function renderCalendar(c) {
      c.innerHTML = `
        <div class="page-header"><h2>ğŸ“… Content Calendar</h2><p>LÃªn lá»‹ch ná»™i dung production pipeline</p></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-outline btn-sm" onclick="calM--;if(calM<0){calM=11;calY--;}loadCal()">&lt;</button>
            <h3 id="cal-label" style="min-width:160px;text-align:center;color:var(--text-bright)"></h3>
            <button class="btn btn-outline btn-sm" onclick="calM++;if(calM>11){calM=0;calY++;}loadCal()">&gt;</button>
          </div>
          <button class="btn btn-primary btn-sm" onclick="showAddCal()">+ ThÃªm ná»™i dung</button>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
        <h4 style="margin:24px 0 12px;color:var(--text-bright)">ğŸ“‹ Káº¿ hoáº¡ch thÃ¡ng nÃ y</h4>
        <div id="cal-list"></div>`;
      await loadCal();
    }

    async function loadCal() {
      try {
        calData = await api('/api/admin/calendar');
        const sched = calData.schedule || [];
        const months = ['ThÃ¡ng 1','ThÃ¡ng 2','ThÃ¡ng 3','ThÃ¡ng 4','ThÃ¡ng 5','ThÃ¡ng 6','ThÃ¡ng 7','ThÃ¡ng 8','ThÃ¡ng 9','ThÃ¡ng 10','ThÃ¡ng 11','ThÃ¡ng 12'];
        document.getElementById('cal-label').textContent = `${months[calM]} ${calY}`;
        const fd = new Date(calY, calM, 1), ld = new Date(calY, calM+1, 0);
        const sd = fd.getDay(), td = ld.getDate(), today = new Date();
        let h = ['CN','T2','T3','T4','T5','T6','T7'].map(d=>`<div class="cal-header">${d}</div>`).join('');
        const pm = new Date(calY, calM, 0).getDate();
        for (let i = sd-1; i >= 0; i--) h += `<div class="cal-day other-month"><div class="cal-day-num">${pm-i}</div></div>`;
        for (let d = 1; d <= td; d++) {
          const ds = `${calY}-${String(calM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const isT = today.getDate()===d && today.getMonth()===calM && today.getFullYear()===calY;
          const evs = sched.filter(s => s.scheduledDate === ds);
          h += `<div class="cal-day ${isT?'today':''} ${evs.length?'has-content':''}" onclick="showAddCal('${ds}')"><div class="cal-day-num">${d}</div>${evs.map(e=>`<div class="cal-event ${e.status}" title="${esc(e.title)}" onclick="event.stopPropagation();showCalItem('${e.id}')">${esc(e.title)}</div>`).join('')}</div>`;
        }
        const rem = 7 - ((sd + td) % 7);
        if (rem < 7) for (let i = 1; i <= rem; i++) h += `<div class="cal-day other-month"><div class="cal-day-num">${i}</div></div>`;
        document.getElementById('cal-grid').innerHTML = h;

        const mi = sched.filter(s => s.scheduledDate?.startsWith(`${calY}-${String(calM+1).padStart(2,'0')}`));
        const le = document.getElementById('cal-list');
        if (!mi.length) { le.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“…</div><p>ChÆ°a cÃ³ ná»™i dung thÃ¡ng nÃ y</p></div>'; }
        else { le.innerHTML = mi.sort((a,b)=>a.scheduledDate.localeCompare(b.scheduledDate)).map(i=>`<div class="run-card"><div class="run-info"><div class="run-name">${esc(i.title)}</div><div class="run-meta">ğŸ“… ${i.scheduledDate} ${i.scheduledTime||''} Â· ${CAT[i.category]||i.category||'general'}</div></div><span class="badge badge-${i.status}">${i.status}</span><button class="btn btn-danger btn-sm" onclick="delCal('${i.id}')" style="margin-left:8px">ğŸ—‘ï¸</button></div>`).join(''); }
      } catch(e) { document.getElementById('cal-grid').innerHTML = `<p style="color:var(--danger);grid-column:1/-1;text-align:center;padding:40px">${e.message}</p>`; }
    }

    function showAddCal(date) {
      const dv = date || `${calY}-${String(calM+1).padStart(2,'0')}-${String(new Date().getDate()).padStart(2,'0')}`;
      openModal('ThÃªm ná»™i dung');
      document.getElementById('modal-body').innerHTML = `
        <div class="form-group" style="margin-bottom:16px"><label>Chá»§ Ä‘á»</label><input type="text" id="cal-title" placeholder="TiÃªu Ä‘á» video"></div>
        <div class="form-group" style="margin-bottom:16px"><label>MÃ´ táº£</label><textarea id="cal-desc" rows="2" placeholder="MÃ´ táº£ ngáº¯n"></textarea></div>
        <div class="form-row" style="margin-bottom:16px">
          <div class="form-group"><label>NgÃ y</label><input type="date" id="cal-date" value="${dv}"></div>
          <div class="form-group"><label>Giá»</label><input type="time" id="cal-time" value="18:00"></div>
          <div class="form-group"><label>Danh má»¥c</label><select id="cal-cat">${Object.entries(CAT).map(([k,v])=>`<option value="${k}">${v}</option>`).join('')}</select></div>
        </div>
        <button class="btn btn-primary" onclick="addCal()">âœ… ThÃªm vÃ o lá»‹ch</button>`;
    }

    async function addCal() {
      const t = document.getElementById('cal-title').value.trim();
      if (!t) return toast('Nháº­p tiÃªu Ä‘á»','error');
      try {
        await apiPost('/api/admin/calendar/add', { title: t, description: document.getElementById('cal-desc').value.trim(), scheduledDate: document.getElementById('cal-date').value, scheduledTime: document.getElementById('cal-time').value, category: document.getElementById('cal-cat').value });
        closeModal(); toast('ÄÃ£ thÃªm!','success'); loadCal();
      } catch(e) { toast(e.message,'error'); }
    }

    async function delCal(id) { if (!confirm('XÃ³a?')) return; try { await apiDelete(`/api/admin/calendar/delete/${id}`); toast('ÄÃ£ xÃ³a','info'); loadCal(); } catch(e) { toast(e.message,'error'); } }

    function showCalItem(id) {
      const i = calData?.schedule?.find(s => s.id === id);
      if (!i) return;
      openModal(i.title);
      document.getElementById('modal-body').innerHTML = `
        <div class="transcript-meta"><div class="transcript-meta-item"><strong>NgÃ y:</strong> ${i.scheduledDate} ${i.scheduledTime||''}</div><div class="transcript-meta-item"><strong>Danh má»¥c:</strong> ${CAT[i.category]||i.category}</div><div class="transcript-meta-item"><strong>Tráº¡ng thÃ¡i:</strong> <span class="badge badge-${i.status}">${i.status}</span></div></div>
        ${i.description?`<p style="margin-top:12px">${esc(i.description)}</p>`:''}
        <div style="margin-top:20px;display:flex;gap:8px">
          <button class="btn btn-primary btn-sm" onclick="closeModal();document.querySelector('[data-page=generate]').click();setTimeout(()=>{document.getElementById('gen-topic').value='${esc(i.title).replace(/'/g,"\\'")}'},300)">âœï¸ Táº¡o Script</button>
          <button class="btn btn-danger btn-sm" onclick="closeModal();delCal('${i.id}')">ğŸ—‘ï¸ XÃ³a</button>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIDEOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let vP = 1, vS = '', vC = '', vQ = '';
    async function renderVideos(c) {
      c.innerHTML = `<div class="page-header"><h2>ğŸ¬ Video Transcripts</h2><p>815 transcripts tá»« 4 nguá»“n</p></div>
        <div class="table-wrap"><div class="table-toolbar">
          <input class="search-input" type="text" placeholder="TÃ¬m kiáº¿m..." id="vsearch" value="${vQ}">
          <select class="filter-select" id="fsrc"><option value="">Táº¥t cáº£ nguá»“n</option><option value="hiddenself" ${vS==='hiddenself'?'selected':''}>HIDDEN SELF</option><option value="thuattaivan" ${vS==='thuattaivan'?'selected':''}>THUáº¬T TÃ€I Váº¬N</option><option value="hormozi" ${vS==='hormozi'?'selected':''}>Hormozi</option><option value="akbimatluatngam" ${vS==='akbimatluatngam'?'selected':''}>áº¨n BÃ­ Máº­t</option></select>
          <select class="filter-select" id="fcat"><option value="">Táº¥t cáº£ danh má»¥c</option>${Object.entries(CAT).map(([k,v])=>`<option value="${k}" ${vC===k?'selected':''}>${v}</option>`).join('')}</select>
        </div><div id="vtbody"><div class="loading"><div class="spinner"></div>Äang táº£i...</div></div><div class="pagination" id="vpag"></div></div>`;
      let t; document.getElementById('vsearch').addEventListener('input', (e) => { clearTimeout(t); t = setTimeout(() => { vQ=e.target.value; vP=1; loadV(); }, 400); });
      document.getElementById('fsrc').addEventListener('change', (e) => { vS=e.target.value; vP=1; loadV(); });
      document.getElementById('fcat').addEventListener('change', (e) => { vC=e.target.value; vP=1; loadV(); });
      loadV();
    }

    async function loadV() {
      const tb = document.getElementById('vtbody');
      tb.innerHTML = '<div class="loading"><div class="spinner"></div>Äang táº£i...</div>';
      try {
        const p = new URLSearchParams(); if (vS) p.set('source', vS); if (vC) p.set('category', vC); if (vQ) p.set('q', vQ); p.set('page', vP); p.set('limit', 30);
        const d = await api(`/api/admin/knowledge/videos?${p}`);
        if (!d.videos.length) { tb.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”</div><p>KhÃ´ng tÃ¬m tháº¥y</p></div>'; document.getElementById('vpag').innerHTML = ''; return; }
        tb.innerHTML = `<table><thead><tr><th style="width:40px">#</th><th>TiÃªu Ä‘á»</th><th>Nguá»“n</th><th>Danh má»¥c</th><th style="text-align:right">Views</th></tr></thead><tbody>${d.videos.map((v,i)=>`<tr><td style="color:var(--text-dim)">${(vP-1)*30+i+1}</td><td><div class="video-title" onclick="showT('${v.videoId}')">${v.title||v.videoId}</div></td><td><span class="badge badge-source">${v.sourceLabel||v.source}</span></td><td><span class="badge badge-cat">${CAT[v.category]||v.category}</span></td><td style="text-align:right;font-weight:600">${fmt(v.viewCount||0)}</td></tr>`).join('')}</tbody></table>`;
        document.getElementById('vpag').innerHTML = `<div class="pagination-info">Trang ${d.page}/${d.totalPages||1} Â· ${d.total} videos</div><div class="pagination-btns"><button class="page-btn" onclick="vP--;loadV()" ${d.page<=1?'disabled':''}>â†</button><button class="page-btn" onclick="vP++;loadV()" ${d.page>=(d.totalPages||1)?'disabled':''}>â†’</button></div>`;
      } catch(e) { tb.innerHTML = `<p style="color:var(--danger);padding:20px">${e.message}</p>`; }
    }

    async function showT(id) {
      openModal('Äang táº£i...');
      try {
        const d = await api(`/api/admin/knowledge/video/${id}`);
        document.getElementById('modal-title').textContent = d.title || id;
        document.getElementById('modal-body').innerHTML = `<div class="transcript-meta"><div class="transcript-meta-item"><strong>Nguá»“n:</strong> ${d.sourceLabel||d.source}</div><div class="transcript-meta-item"><strong>Danh má»¥c:</strong> ${CAT[d.category]||d.category}</div><div class="transcript-meta-item"><strong>Views:</strong> ${fmt(d.viewCount||0)}</div></div><div class="transcript-content">${esc(d.content||'')}</div>`;
      } catch(e) { document.getElementById('modal-body').innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• BRAIN & VOICE â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderBrain(c) {
      c.innerHTML = `<div class="page-header"><h2>ğŸ§  Brain & Voice DNA</h2></div><div class="tabs"><button class="tab-btn active" onclick="swB('brain',this)">ğŸ§  BRAIN</button><button class="tab-btn" onclick="swB('voice',this)">ğŸ¤ VOICE</button></div><div id="bc"><div class="loading"><div class="spinner"></div>Äang táº£i...</div></div>`;
      try { const d = await api('/api/admin/knowledge/brain'); window._bd = d; document.getElementById('bc').innerHTML = `<div style="margin-bottom:12px;font-size:13px;color:var(--text-dim)">ğŸ“„ ${fmt(d.brainSize)} chars</div><div class="content-viewer">${esc(d.brain||'')}</div>`; }
      catch(e) { document.getElementById('bc').innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
    }
    function swB(t, btn) { document.querySelectorAll('.tabs .tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const d=window._bd; if(!d)return; document.getElementById('bc').innerHTML = `<div style="margin-bottom:12px;font-size:13px;color:var(--text-dim)">ğŸ“„ ${fmt(t==='brain'?d.brainSize:d.voiceSize)} chars</div><div class="content-viewer">${esc(t==='brain'?d.brain:d.voice||'')}</div>`; }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• SEARCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderSearch(c) {
      c.innerHTML = `<div class="page-header"><h2>ğŸ” TÃ¬m kiáº¿m Knowledge</h2></div><div class="pipeline-form"><div class="form-row"><div class="form-group" style="flex:3"><label>Tá»« khÃ³a</label><input type="text" id="sq" placeholder="tÃ¢m lÃ½ Ä‘Ã¡m Ä‘Ã´ng, Ä‘áº§u tÆ°..."></div><div class="form-group" style="flex:1"><label>Nguá»“n</label><select id="ss"><option value="">Táº¥t cáº£</option><option value="hiddenself">HIDDEN SELF</option><option value="thuattaivan">THUáº¬T TÃ€I Váº¬N</option><option value="hormozi">Hormozi</option><option value="akbimatluatngam">áº¨n BÃ­ Máº­t</option></select></div><button class="btn btn-primary" onclick="doSrch()">ğŸ”</button></div></div><div id="sr"></div>`;
      document.getElementById('sq').addEventListener('keypress', (e) => { if (e.key === 'Enter') doSrch(); });
    }

    async function doSrch() {
      const q = document.getElementById('sq').value.trim(); if (!q) return;
      const src = document.getElementById('ss').value;
      const r = document.getElementById('sr');
      r.innerHTML = '<div class="loading"><div class="spinner"></div>Äang tÃ¬m...</div>';
      try {
        const p = new URLSearchParams({ q, maxResults: 15 }); if (src) p.set('source', src);
        const d = await api(`/api/admin/knowledge/search?${p}`);
        let h = '';
        if (d.transcripts?.length) { h += `<h3 style="margin:20px 0 12px;color:var(--text-bright)">ğŸ¬ Videos (${d.transcripts.length})</h3>`; h += d.transcripts.map(t=>`<div class="run-card" style="cursor:pointer" onclick="showT('${t.videoId}')"><div class="run-info"><div class="run-name">${esc(t.title)}</div><div class="run-meta"><span class="badge badge-source">${t.sourceLabel}</span> <span class="badge badge-cat">${CAT[t.category]||t.category}</span> Â· ${fmt(t.viewCount)} views</div></div></div>`).join(''); }
        if (d.books?.length) { h += `<h3 style="margin:20px 0 12px;color:var(--text-bright)">ğŸ“š SÃ¡ch (${d.books.length})</h3>`; h += d.books.map(b=>`<div class="run-card"><div class="run-info"><div class="run-name">${esc(b.title)}</div><div class="run-meta">${b.category}</div></div></div>`).join(''); }
        if (d.brainExcerpt) { h += `<h3 style="margin:20px 0 12px;color:var(--text-bright)">ğŸ§  BRAIN</h3><div class="content-viewer" style="max-height:300px">${esc(d.brainExcerpt.substring(0,1500))}</div>`; }
        r.innerHTML = h || '<div class="empty-state"><div class="icon">ğŸ”</div><p>KhÃ´ng tÃ¬m tháº¥y</p></div>';
      } catch(e) { r.innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• PIPELINE â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderPipeline(c) {
      c.innerHTML = `<div class="page-header"><h2>âš¡ Pipeline</h2></div><div class="pipeline-form"><div class="form-row"><div class="form-group" style="flex:2"><label>Chá»§ Ä‘á»</label><input type="text" id="pl-topic" placeholder="Topic..."></div><div class="form-group"><label>Video URL</label><input type="text" id="pl-url" placeholder="https://youtube.com/..."></div><button class="btn btn-primary" onclick="trigPipe()">ğŸš€ Cháº¡y</button></div></div><div id="pl-runs"><div class="loading"><div class="spinner"></div>Äang táº£i...</div></div>`;
      loadRuns();
    }
    async function loadRuns() { try { const d = await api('/api/admin/pipeline/runs'); const el = document.getElementById('pl-runs'); if (!d.runs.length) { el.innerHTML = '<div class="empty-state"><div class="icon">âš¡</div><p>ChÆ°a cÃ³ run</p></div>'; return; } el.innerHTML = d.runs.map(r=>`<div class="run-card"><div class="run-info"><div class="run-name">${r.pipelineName||r.pipelineId}</div><div class="run-id">${r.runId}</div><div class="run-meta">${(r.durationMs/1000).toFixed(1)}s</div></div><span class="badge badge-${r.status==='completed'?'success':r.status==='failed'?'danger':'running'}">${r.status}</span></div>`).join(''); } catch(e) { document.getElementById('pl-runs').innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; } }
    async function trigPipe() { const t = document.getElementById('pl-topic').value.trim(), u = document.getElementById('pl-url').value.trim(); if (!t && !u) return toast('Nháº­p topic/URL','error'); try { const b = {}; if(t) b.topic=t; if(u) b.videoUrl=u; await apiPost('/api/youtube-crew/trigger', b); toast('Pipeline started','success'); document.getElementById('pl-topic').value=''; document.getElementById('pl-url').value=''; setTimeout(loadRuns, 1000); } catch(e) { toast(e.message,'error'); } }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• OUTPUTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function renderOutputs(c) {
      c.innerHTML = `<div class="page-header"><h2>ğŸ“¦ Videos Output</h2></div><div id="out-list"><div class="loading"><div class="spinner"></div>Äang táº£i...</div></div>`;
      try { const d = await api('/api/admin/outputs'); const el = document.getElementById('out-list'); if (!d.outputs.length) { el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“¦</div><p>ChÆ°a cÃ³ output</p></div>'; return; } el.innerHTML = d.outputs.map(o=>`<div class="run-card"><div class="run-info"><div class="run-name">${esc(o.metadata?.title||o.id)}</div><div class="run-meta">${o.hasVideo?'ğŸ¬':''}${o.hasScript?'ğŸ“':''} Â· ${o.files.length} files Â· ${new Date(o.createdAt).toLocaleDateString('vi-VN')}</div></div>${o.hasVideo?'<span class="badge badge-success">Video</span>':'<span class="badge badge-warning">Script</span>'}</div>`).join(''); }
      catch(e) { document.getElementById('out-list').innerHTML = `<p style="color:var(--danger)">${e.message}</p>`; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openModal(t) { document.getElementById('modal-title').textContent = t; document.getElementById('modal-body').innerHTML = '<div class="loading"><div class="spinner"></div>Äang táº£i...</div>'; document.getElementById('modal-overlay').classList.add('active'); }
    function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); }
    document.getElementById('modal-overlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    renderPage('dashboard');
  </script>
</body>
</html>
