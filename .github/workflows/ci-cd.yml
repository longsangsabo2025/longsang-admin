# ğŸš€ GitHub Actions CI/CD Pipeline
# 
# Triggers:
# - Push to main/master
# - Pull requests
# - Sentry webhook (via repository_dispatch)
#
# Jobs:
# 1. Test - Run tests
# 2. Build - Build production
# 3. Deploy - Deploy to Vercel
# 4. Auto-fix - Attempt to fix failing tests

name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  repository_dispatch:
    types: [sentry-error]
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Attempt auto-fix for failing tests'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'

jobs:
  # ========================================
  # ğŸ§ª TEST JOB
  # ========================================
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ” Lint
        run: npm run lint || true
        continue-on-error: true
      
      - name: ğŸ“˜ Type check
        run: npx tsc --noEmit || true
        continue-on-error: true
      
      - name: ğŸ§ª Run tests
        run: npm run test:coverage || true
        env:
          CI: true
      
      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v5
        if: always()
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false

  # ========================================
  # ğŸ—ï¸ BUILD JOB
  # ========================================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build
        run: npm run build
        continue-on-error: true
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          retention-days: 7

  # ========================================
  # ğŸš€ DEPLOY JOB
  # ========================================
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
      
      - name: ğŸ“¢ Notify success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          # Add Slack/Discord notification here

  # ========================================
  # ğŸ”§ AUTO-FIX JOB (Triggered by Sentry)
  # ========================================
  auto-fix:
    name: ğŸ”§ Auto-Fix
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch' && github.event.action == 'sentry-error'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ“ Get error details
        id: error
        run: |
          echo "Error: ${{ github.event.client_payload.error_message }}"
          echo "File: ${{ github.event.client_payload.error_file }}"
          echo "Line: ${{ github.event.client_payload.error_line }}"
      
      - name: ğŸ” Analyze error
        run: |
          echo "ğŸ” Analyzing error..."
          npm run lint -- --fix || true
          npx prettier --write "src/**/*.{ts,tsx,js,jsx,json,css,scss,md}" || true
      
      - name: ğŸ”§ Create fix branch
        run: |
          BRANCH_NAME="auto-fix/sentry-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: ğŸ“ Commit changes
        run: |
          git config --global user.name 'Auto-Fix Bot'
          git config --global user.email 'bot@longsang.org'
          git add -A
          git diff --staged --quiet || git commit -m "fix: auto-fix from Sentry error

          Error: ${{ github.event.client_payload.error_message }}
          Sentry Issue: ${{ github.event.client_payload.sentry_url }}"
      
      - name: ğŸ“¤ Push changes
        run: |
          git push origin ${{ env.BRANCH_NAME }}
      
      - name: ğŸ”ƒ Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "ğŸ”§ Auto-fix: Sentry Error"
          body: |
            ## ğŸš¨ Sentry Error Detected
            
            **Error:** ${{ github.event.client_payload.error_message }}
            **File:** ${{ github.event.client_payload.error_file }}
            **Line:** ${{ github.event.client_payload.error_line }}
            
            ## ğŸ”§ Auto-Fix Applied
            
            This PR was automatically generated to address a production error detected by Sentry.
            
            ### Review Checklist
            - [ ] Verify the fix is correct
            - [ ] Run tests locally
            - [ ] Check for side effects
            
            ---
            *Generated by Auto-Fix Bot ğŸ¤–*
          labels: auto-fix,sentry,urgent
