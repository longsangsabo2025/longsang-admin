# ============================================================================
# ðŸš¨ SENTRY AUTO-FIX PIPELINE - Elon Musk Edition
# ============================================================================
name: ðŸ› Sentry Auto-Fix

on:
  repository_dispatch:
    types: [sentry-error]
  workflow_dispatch:
    inputs:
      error_title:
        description: 'Error title'
        required: true
        default: 'TypeError: Cannot read property'
      error_message:
        description: 'Error message'
        required: true
        default: 'Cannot read property of undefined'
      file_path:
        description: 'File path'
        required: false
        default: 'src/components/Example.tsx'
      line_number:
        description: 'Line number'
        required: false
        default: '1'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  analyze:
    name: ðŸ” Analyze Error
    runs-on: ubuntu-latest
    outputs:
      should_fix: ${{ steps.analyze.outputs.should_fix }}
      fix_type: ${{ steps.analyze.outputs.fix_type }}
      confidence: ${{ steps.analyze.outputs.confidence }}
      error_title: ${{ steps.analyze.outputs.error_title }}
      error_message: ${{ steps.analyze.outputs.error_message }}
      file_path: ${{ steps.analyze.outputs.file_path }}
      line_number: ${{ steps.analyze.outputs.line_number }}
    
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Analyze Error Pattern
        id: analyze
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            ERROR_TITLE="${{ github.event.client_payload.error_title }}"
            ERROR_MESSAGE="${{ github.event.client_payload.error_message }}"
            FILE_PATH="${{ github.event.client_payload.file_path }}"
            LINE_NUMBER="${{ github.event.client_payload.line_number }}"
          else
            ERROR_TITLE="${{ github.event.inputs.error_title }}"
            ERROR_MESSAGE="${{ github.event.inputs.error_message }}"
            FILE_PATH="${{ github.event.inputs.file_path }}"
            LINE_NUMBER="${{ github.event.inputs.line_number }}"
          fi
          
          echo "ðŸ” Analyzing: $ERROR_TITLE"
          
          FIX_TYPE="manual"
          SHOULD_FIX="false"
          CONFIDENCE="low"
          
          if [[ "$ERROR_TITLE" == *"TypeError"* ]] && [[ "$ERROR_MESSAGE" == *"undefined"* || "$ERROR_MESSAGE" == *"null"* ]]; then
            FIX_TYPE="null-safety"
            SHOULD_FIX="true"
            CONFIDENCE="high"
          elif [[ "$ERROR_MESSAGE" == *"is not a function"* ]]; then
            FIX_TYPE="type-guard"
            SHOULD_FIX="true"
            CONFIDENCE="high"
          elif [[ "$ERROR_TITLE" == *"SyntaxError"* ]]; then
            FIX_TYPE="syntax"
            SHOULD_FIX="true"
            CONFIDENCE="high"
          elif [[ "$ERROR_MESSAGE" == *"Network"* ]] || [[ "$ERROR_MESSAGE" == *"fetch"* ]]; then
            FIX_TYPE="network"
            SHOULD_FIX="true"
            CONFIDENCE="medium"
          fi
          
          echo "should_fix=$SHOULD_FIX" >> $GITHUB_OUTPUT
          echo "fix_type=$FIX_TYPE" >> $GITHUB_OUTPUT
          echo "confidence=$CONFIDENCE" >> $GITHUB_OUTPUT
          echo "error_title=$ERROR_TITLE" >> $GITHUB_OUTPUT
          echo "error_message=$ERROR_MESSAGE" >> $GITHUB_OUTPUT
          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
          echo "line_number=$LINE_NUMBER" >> $GITHUB_OUTPUT

  create-issue:
    name: ðŸ“ Create Issue
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should_fix == 'true'
    outputs:
      issue_number: ${{ steps.issue.outputs.issue_number }}
    
    steps:
      - name: ðŸ“ Create GitHub Issue
        id: issue
        uses: actions/github-script@v7
        env:
          FIX_TYPE: ${{ needs.analyze.outputs.fix_type }}
          CONFIDENCE: ${{ needs.analyze.outputs.confidence }}
          ERROR_TITLE: ${{ needs.analyze.outputs.error_title }}
          ERROR_MESSAGE: ${{ needs.analyze.outputs.error_message }}
          FILE_PATH: ${{ needs.analyze.outputs.file_path }}
          LINE_NUMBER: ${{ needs.analyze.outputs.line_number }}
        with:
          script: |
            const { FIX_TYPE, CONFIDENCE, ERROR_TITLE, ERROR_MESSAGE, FILE_PATH, LINE_NUMBER } = process.env;
            
            const body = [
              '## ðŸš¨ Sentry Error Detected',
              '',
              '### Error Details',
              '| Field | Value |',
              '|-------|-------|',
              '| Type | `' + ERROR_TITLE + '` |',
              '| Message | ' + ERROR_MESSAGE + ' |',
              '| File | `' + FILE_PATH + '` |',
              '| Line | ' + LINE_NUMBER + ' |',
              '',
              '### Fix Strategy',
              '- Fix Type: `' + FIX_TYPE + '`',
              '- Confidence: **' + CONFIDENCE + '**',
              '',
              '---',
              '*Auto-generated by Sentry Auto-Fix Pipeline*'
            ].join('\n');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ› [Auto-Fix] ' + ERROR_TITLE,
              body: body,
              labels: ['bug', 'auto-fix', 'sentry']
            });
            
            core.setOutput('issue_number', issue.data.number);

  apply-fix:
    name: ðŸ”§ Apply Fix
    runs-on: ubuntu-latest
    needs: [analyze, create-issue]
    if: needs.analyze.outputs.should_fix == 'true'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Create branch
        run: |
          BRANCH="auto-fix/sentry-${{ github.run_number }}"
          git checkout -b $BRANCH
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“š Install
        run: npm ci || npm install --legacy-peer-deps
        continue-on-error: true

      - name: ðŸ” ESLint Fix
        run: npm run lint -- --fix --max-warnings=9999 || true
        continue-on-error: true

      - name: ðŸ’… Prettier
        run: npx prettier --write "src/**/*.{ts,tsx}" || true
        continue-on-error: true

      - name: ðŸ“ Check changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ Commit
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.email "bot@longsang.org"
          git config user.name "Sentry Bot"
          git add -A
          git commit -m "fix: ðŸ¤– auto-fix #${{ needs.create-issue.outputs.issue_number }}"
          git push origin ${{ env.BRANCH }}

      - name: ðŸ”„ Create PR
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ env.BRANCH }}
          ISSUE_NUMBER: ${{ needs.create-issue.outputs.issue_number }}
          FIX_TYPE: ${{ needs.analyze.outputs.fix_type }}
          ERROR_TITLE: ${{ needs.analyze.outputs.error_title }}
        with:
          script: |
            const { BRANCH, ISSUE_NUMBER, FIX_TYPE, ERROR_TITLE } = process.env;
            
            const body = [
              '## ðŸ¤– Sentry Auto-Fix PR',
              '',
              'Closes #' + ISSUE_NUMBER,
              '',
              '### Changes',
              '- ESLint auto-fixes applied',
              '- Prettier formatting applied',
              '- Fix Type: `' + FIX_TYPE + '`',
              '',
              '---',
              '*Auto-generated by Sentry Auto-Fix Pipeline*'
            ].join('\n');
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– Auto-Fix: ' + ERROR_TITLE,
              head: BRANCH,
              base: 'main',
              body: body
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['auto-fix', 'bot']
            });

  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [analyze, create-issue, apply-fix]
    if: always()
    
    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "# ðŸš€ SENTRY AUTO-FIX" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Analyze | ${{ needs.analyze.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Issue | ${{ needs.create-issue.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Apply Fix | ${{ needs.apply-fix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Fix Type: **${{ needs.analyze.outputs.fix_type }}**" >> $GITHUB_STEP_SUMMARY
